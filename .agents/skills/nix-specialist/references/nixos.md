# NixOS

## 1. 目的

NixOSのモジュール構成、オプション運用、反映手順を実務向けに確認するための参照。

## 2. 要点

- `configuration.nix` を起点に宣言的にシステム状態を定義する。
- モジュールは `options` と `config` に分かれ、再利用可能な設定単位を作れる。
- `imports` で機能別ファイル分割を行う。
- 世代（generation）管理によりロールバック可能な運用を取れる。
- `nixos-rebuild switch|boot|test` を目的に応じて使い分ける。
- `hardware-configuration.nix` はホスト依存情報として分離維持する。
- システムパッケージとユーザー設定（Home Manager等）を役割分担する。

## 3. オプション調査の型

1. 要件をサービス/ネットワーク/セキュリティ/開発環境に分類する。
2. 該当オプションを確認し、型・既定値・影響範囲を把握する。
3. まず `test` で適用し、問題なければ `switch` へ進める。
4. 起動影響がある変更は `boot` も検討する。

## 4. 誤りやすい点

- 一度に多数オプションを変更し、原因切り分けが不能になる。
- ユーザー領域の設定までシステムモジュールに過剰集約する。
- 手動変更を先に行い、宣言的状態との差分が肥大化する。

## 5. ベストプラクティス

- 変更は小さく分け、1変更ごとに再ビルドと確認を行う。
- `imports` でドメインごとに整理し、責務境界を明確にする。
- `nixos-rebuild test` を活用して反映前の安全確認を行う。
- ロールバック前提で、失敗時の復旧手順を常に保持する。

## 6. 主要参照

- NixOS Manual (stable)
- Nix Manual (CLI/運用コマンド関連)
