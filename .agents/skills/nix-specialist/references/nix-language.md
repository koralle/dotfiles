# Nix言語

## 1. 目的

Nix式の基本構文、評価モデル、`builtins`/`lib` の使い分けを短時間で再確認するための参照。

## 2. 要点

- Nixは純粋関数型かつ遅延評価を前提にする。
- 値は主に属性セット、リスト、文字列、パス、関数で構成する。
- `let ... in ...` で局所変数を束縛する。
- 属性セット更新は `//` を使う。
- 関数引数は単一引数が基本で、属性セット引数で疑似名前付き引数を表現する。
- `rec` 属性セットで同一セット内の相互参照を許可する。
- `inherit` で冗長な再代入を避ける。
- `builtins` は言語組み込み、`lib` は `nixpkgs` 提供ヘルパ群と捉える。

## 3. 実務で多用するユーティリティ

- `lib.mkIf cond attrs`:
  条件に応じて設定を有効化する。
- `lib.mkMerge [a b c]`:
  複数設定を段階的に統合する。
- `lib.optional cond x` / `lib.optionals cond xs`:
  条件付きでリスト要素を追加する。
- `lib.attrsets`:
  属性セットの変換・再構成を行う。
- `builtins.trace`:
  評価時デバッグに使う（本番設定に残さない）。

## 4. 誤りやすい点

- 即時評価だと思い込み、未評価の式のエラー位置を誤解する。
- `lib` と `builtins` の責務を混同する。
- 型不一致（文字列/パス/リスト）を雑に扱う。
- 暗黙依存のある絶対パスを設定内に直接書く。

## 5. ベストプラクティス

- 値を小さい関数に分解し、再利用可能な粒度で定義する。
- 共通処理を `lib` ヘルパに寄せて重複を減らす。
- エラー調査時は式を最小化し、評価対象を段階的に広げる。
- 一時デバッグの `trace` は最終的に除去する。

## 6. 主要参照

- Nix Reference Manual
- Nix Manual (2.24 系)
- Zenn: `nix-introduction`
